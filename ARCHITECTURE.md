# Cast Brain / Repo-Brain Architecture

Autonomous multi-repo governance engine for protocol-grade repos, built around a **hospital pipeline**, **fleet orchestrator**, **operator dashboard**, and **CLI control plane (`brainctl`)**.

---

## 1. High-level system overview

- **Scope:** Govern a fleet of repositories via a shared `.repo-brain` hospital.
- **Core guarantees:**
  - **Non-destructive:** Never mutates business logic or tests without explicit, human-reviewed intent.
  - **Deterministic:** Same inputs (repo state + config) → same diagnosis and safe-fix plan.
  - **Fleet-aware:** Single-repo and multi-repo (fleet) modes share the same pipeline semantics.
  - **Cross-platform:** Works on Linux/macOS/Windows (Git Bash) with `jq` or Node fallback.

### 1.1 Major subsystems

1. **Hospital pipeline (per-repo)**
   - Shell scripts under `.repo-brain/brain.*.sh` (in this fork, at repo root).
   - Responsible for detection, normalization, diagnosis, safe fixes, verification, and AI guardrails.

2. **Fleet orchestrator**
   - `brain.fleet.sh` + `brainctl fleet` mode.
   - Runs the hospital pipeline across many repos, aggregates fleet-wide health.

3. **Operator dashboard**
   - Next.js / React UI (in this fork: `App.tsx`, `components/`, `services/`).
   - Visualizes vitals, diagnoses, fleet status, and execution history.

4. **CLI control plane (`brainctl`)**
   - `brainctl.sh` entrypoint.
   - Human and CI interface for doctor/surgeon/autopsy/genome/firewall/vitals/fleet.

5. **Versioning and provenance**
   - `.repo-brain.versions/` (in canonical design) stores immutable versions of the hospital.
   - Active version is copied into `.repo-brain/` for execution.
   - Autopsy + blackbox logs provide replayable provenance.

---

## 2. Core pipeline: `brain.run.sh`

**File:** `brain.run.sh`  
**Role:** Single entrypoint for the hospital pipeline. CI and humans should call this (or `brainctl run`).

### 2.1 Responsibilities

1. **Environment bootstrap**
   - Resolve repo root.
   - Locate `.repo-brain` (or equivalent hospital directory).
   - Ensure required scripts exist and are executable.
   - Configure JSON tooling:
     - Prefer `jq` if available.
     - Fallback to Node (`node -e` snippets) for JSON transforms.

2. **Pipeline orchestration**

The canonical execution order:

1. `brain.detect.sh`
2. `brain.scan-actions.sh`
3. `brain.frameworks.sh`
4. `brain.frameworks.ci.sh`
5. `brain.solidity.detect.sh`
6. `brain.solidity.ci.sh`
7. `brain.rust.sh`
8. `brain.normalize.sh`
9. `brain.diagnose.sh`
10. `brain.fix.safe.sh`
11. `brain.verify.sh`
12. `brain.ai.guard.sh`
13. `brain.greenlock.sh`
14. `brain.guard.sh`
15. (optional) `brain.fleet.sh`

3. **GitHub Actions autodeploy**
   - If standard CI workflows are missing, auto-copy templates into `.github/workflows/` for:
     - Next.js / Vite / React
     - Nuxt / SvelteKit / Astro / Remix
     - Rust
     - Solidity (Foundry / Hardhat)
     - Python
     - Generic Node

### 2.2 Guarantees

- **Fail-fast on structural issues:**
  - Missing core scripts → hard failure with clear error.
- **Soft-fail on non-critical steps:**
  - Individual script failures are logged and surfaced in diagnosis, but do not crash the entire run unless configured.
- **Safety:**
  - No direct edits to `src/`, `contracts/`, or test directories unless:
    - Change is generated by a safe-fix module, and
    - Explicitly allowed by configuration.

---

## 3. Hospital modules

Each module is a shell script with a narrow, composable responsibility.

### 3.1 `brain.detect.sh` — language & framework detection

- **Inputs:** Repo filesystem, `package.json`, `tsconfig.json`, `vercel.json`, CI files.
- **Outputs:**
  - `brain.detect.json` (language/framework matrix).
  - Flags for:
    - TypeScript/React/Vite
    - Next.js/Nuxt/SvelteKit/Astro/Remix
    - Rust
    - Solidity (Foundry/Hardhat)
    - Python

### 3.2 `brain.scan-actions.sh` — CI surface scan

- **Inputs:** `.github/workflows/*.yml`, repo root.
- **Outputs:**
  - `brain.actions.json` describing:
    - Missing workflows.
    - Deprecated patterns.
    - Unsafe steps (e.g., unpinned actions, `curl | sh`).

### 3.3 `brain.frameworks.sh` — framework topology

- **Inputs:** `brain.detect.json`, project configs.
- **Outputs:**
  - `brain.frameworks.json` describing:
    - UI frameworks.
    - Backend frameworks.
    - Contract toolchains.
    - Build/test commands.

### 3.4 `brain.frameworks.ci.sh` — CI synthesis

- **Inputs:** `brain.frameworks.json`, `brain.actions.json`.
- **Outputs:**
  - Proposed CI workflows (in memory or temp dir).
  - Diff plan for `.github/workflows/`.

### 3.5 `brain.solidity.detect.sh` / `brain.solidity.ci.sh`

- **Role:** Detect Solidity projects and synthesize safe CI:
  - Foundry/Hardhat detection.
  - Test/build/lint steps.
  - Gas reporting and coverage (optional).

### 3.6 `brain.rust.sh`

- **Role:** Detect Rust crates and ensure:
  - `cargo build` / `cargo test` wired into CI.
  - Optional `clippy` and `fmt` steps.

### 3.7 `brain.normalize.sh` — repo normalization

- **Responsibilities:**
  - Normalize line endings and executable bits for hospital scripts.
  - Ensure `.repo-brain` structure is consistent.
  - Optionally enforce basic layout conventions (non-destructive).

### 3.8 `brain.diagnose.sh` — health diagnosis

- **Outputs:**
  - `.repo-brain/brain.health.json`
  - `.repo-brain/brain.health.md`
- **Dimensions:**
  - Script integrity.
  - CI coverage.
  - Framework alignment.
  - Security posture (high-level).
  - Drift from MERMEDA spec.

### 3.9 `brain.fix.safe.sh` — safe remediation

- **Scope:**
  - CI workflows.
  - Hospital scripts.
  - Config files (e.g., `tsconfig.json`, `package.json` scripts).
- **Non-scope (unless explicitly allowed):**
  - Business logic.
  - Contract logic.
  - Tests.

### 3.10 `brain.verify.sh` — verification run

- **Role:** Execute the repo’s canonical build/test commands.
- **Outputs:**
  - `brain.verify.json` with:
    - Exit codes.
    - Duration.
    - Key logs.

### 3.11 `brain.ai.guard.sh` — AI safety guard

- **Responsibilities:**
  - Scan for:
    - Hardcoded secrets.
    - Dangerous subprocess patterns.
    - Suspicious AI-generated code markers.
  - Emit:
    - `.repo-brain/auto-comments/*.md` for inline review comments.

### 3.12 `brain.greenlock.sh` — green state lock

- **Role:** Mark a repo as “green” when:
  - Diagnosis is clean or within thresholds.
  - Verification passes.
  - AI guard has no blocking findings.
- **Outputs:**
  - `.repo-brain/greenlock.json` (or similar) with:
    - Timestamp.
    - Commit hash.
    - Pipeline summary.

### 3.13 `brain.guard.sh` — pre-commit firewall

- **Role:** Install and enforce a pre-commit hook that blocks:
  - Secrets.
  - Dangerous patterns.
  - Direct edits to protected paths without override.

---

## 4. Fleet orchestrator

**File:** `brain.fleet.sh` (plus `brainctl fleet`).

### 4.1 Modes

- `--dashboard` — build/update fleet dashboard artifacts.
- `--autopsy-all` — run autopsy across all repos.
- `--doctor-all` — run doctor across all repos.
- `--surgeon-all` — apply safe fixes across fleet.
- `--genome` — generate fleet-wide genome diffs.

### 4.2 Data products

- `brain.fleet.json` — aggregated health.
- `brain.fleet.vitals.json` — aggregated vitals.
- `brain.fleet.autopsy/` — per-repo autopsy logs.

---

## 5. Operator dashboard

In this fork, the dashboard is implemented as a Vite/React SPA:

- **Entry:** `index.html`, `index.tsx`, `App.tsx`
- **UI components:** `components/`
- **Data services:** `services/`
- **Types:** `types.ts`, `constants.tsx`

### 5.1 Responsibilities

- Render:
  - Repo vitals.
  - Diagnosis summaries.
  - Fleet status distribution.
  - Autopsy timelines.
- Consume:
  - JSON artifacts produced by the hospital and fleet orchestrator.

---

## 6. CLI control plane (`brainctl.sh`)

**File:** `brainctl.sh`

### 6.1 Commands

- `brainctl run` — run full pipeline (wraps `brain.run.sh`).
- `brainctl doctor` — run doctor subset.
- `brainctl surgeon` — run safe-fix subset.
- `brainctl autopsy` — run autopsy and export traces.
- `brainctl genome` — generate genome diffs.
- `brainctl firewall-install` — install pre-commit firewall.
- `brainctl vitals` — collect vitals.
- `brainctl fleet` — run fleet orchestrator.

---

## 7. Cross-platform guarantees

- **Shell:** POSIX-compatible, tested on bash/zsh/Git Bash.
- **JSON:** `jq` preferred; Node fallback ensures Windows compatibility.
- **CI:** GitHub Actions templates are pinned and non-destructive.

---

## 8. Extension points

- **Custom modules:** New `brain.*.sh` scripts can be inserted into the pipeline via config.
- **Custom dashboards:** Additional views can be added to the UI by consuming the same JSON artifacts.
- **Org policies:** Fleet-level policies can be encoded as checks over `brain.fleet.json`.

